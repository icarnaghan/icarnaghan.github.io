<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Cron Queuing in Drupal 8 | Ian Carnaghan</title>
<meta name=keywords content="drupal"><meta name=description content="Day 7 focuses mainly on the Drupal Queue API. The main resource for this card is an article called Drupal 8 Queue API – Powerful Manual and Cron Queueing, which I had referenced in an earlier post. Before completing any of the materials, I had no previous experience with the Queue API, nor hook_entity_insert, which was used to create a demo queue system in the referenced article. After going through the article I gained a better understanding of how the queue system works. At a high level the following steps outline the process of constructing the module that is documented in this article along with relevant links to the API."><meta name=author content="icarnaghan"><link rel=canonical href=https://www.carnaghan.com/cron-queuing-in-drupal-8/><meta name=google-site-verification content="G-7Q7KDW64SY"><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://www.carnaghan.com/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://www.carnaghan.com/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://www.carnaghan.com/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://www.carnaghan.com/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://www.carnaghan.com/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://www.carnaghan.com/cron-queuing-in-drupal-8/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-7Q7KDW64SY"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-7Q7KDW64SY")}</script><meta property="og:url" content="https://www.carnaghan.com/cron-queuing-in-drupal-8/"><meta property="og:site_name" content="Ian Carnaghan"><meta property="og:title" content="Cron Queuing in Drupal 8"><meta property="og:description" content="Day 7 focuses mainly on the Drupal Queue API. The main resource for this card is an article called Drupal 8 Queue API – Powerful Manual and Cron Queueing, which I had referenced in an earlier post. Before completing any of the materials, I had no previous experience with the Queue API, nor hook_entity_insert, which was used to create a demo queue system in the referenced article. After going through the article I gained a better understanding of how the queue system works. At a high level the following steps outline the process of constructing the module that is documented in this article along with relevant links to the API."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-08-13T00:00:00+00:00"><meta property="article:modified_time" content="2016-08-13T00:00:00+00:00"><meta property="article:tag" content="Drupal"><meta property="og:image" content="https://www.carnaghan.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.carnaghan.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Cron Queuing in Drupal 8"><meta name=twitter:description content="Day 7 focuses mainly on the Drupal Queue API. The main resource for this card is an article called Drupal 8 Queue API – Powerful Manual and Cron Queueing, which I had referenced in an earlier post. Before completing any of the materials, I had no previous experience with the Queue API, nor hook_entity_insert, which was used to create a demo queue system in the referenced article. After going through the article I gained a better understanding of how the queue system works. At a high level the following steps outline the process of constructing the module that is documented in this article along with relevant links to the API."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.carnaghan.com/posts/"},{"@type":"ListItem","position":2,"name":"Cron Queuing in Drupal 8","item":"https://www.carnaghan.com/cron-queuing-in-drupal-8/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Cron Queuing in Drupal 8","name":"Cron Queuing in Drupal 8","description":"Day 7 focuses mainly on the Drupal Queue API. The main resource for this card is an article called Drupal 8 Queue API – Powerful Manual and Cron Queueing, which I had referenced in an earlier post. Before completing any of the materials, I had no previous experience with the Queue API, nor hook_entity_insert, which was used to create a demo queue system in the referenced article. After going through the article I gained a better understanding of how the queue system works. At a high level the following steps outline the process of constructing the module that is documented in this article along with relevant links to the API.\n","keywords":["drupal"],"articleBody":"Day 7 focuses mainly on the Drupal Queue API. The main resource for this card is an article called Drupal 8 Queue API – Powerful Manual and Cron Queueing, which I had referenced in an earlier post. Before completing any of the materials, I had no previous experience with the Queue API, nor hook_entity_insert, which was used to create a demo queue system in the referenced article. After going through the article I gained a better understanding of how the queue system works. At a high level the following steps outline the process of constructing the module that is documented in this article along with relevant links to the API.\nCreating the Queue Create the .module file and use hook_entity_insert to grab any newly inserted entities of type node, check publish status, and if unpublished create a queue via the QueueFactory (step). Get the queue factory service via \\Drupal::service(‘queue’) which references the QueueFactory class and then use the get method to create a new queue of type QueueInterface. Instantiate a new class stdclass() called $item and pass in the nid from the inserted entity. Use the QueueInterface createItem method to pass in $item. Building the QueueWorker Plugin We will be getting more into plugins in Day 8, however for the purpose of using the Queue API in this example, a plugin was created to manage publishing of and processing items in the queue.\nCreate the plugin at src/Plugin/QueueWorker which extends QueueWorkerBase and implements the ContainerFactoryPluginInterface. Inject EntityStorageInterface into the plugin (required for publishing nodes). Write the methods for processing queue items and publishing nodes. The Drupal 8 Queue API article setup the plugin as an abstract class and extended it to provide both cron as well as manual calls to the plugin. An additional form was buit to provide user feedback on queue items left and for a way for the user to manually process the queue. The article also provides a git repo of all sourcecode to download and test locally.\nRegistered Users Welcome Email Queue The task for Day 7 was to build a custom module that would similarly use a queue within Drupal 8, only this time instead of queueing inserted nodes, the module would build a queue of new users and then email a welcome message on the next cron run. In order to write this module, I followed similar steps to the article above. First of all I found myself reviewing Drupal 8 Hooks in order to find a registered user hook that I could use for my queue. I quickly realized that no such hook existed and I could in fact use the same hook_entity_insert on users instead of nodes.\nThe next thing I needed to figure out was which service I could use for processing emails. I took a look in core.services.yml and came across MailManager which provides a Mail plugin manager. More detailed documentation for the MailManager function is available and this helped figure out how to use it correctly in my code including what parameters needed to be passed in:\nstring $module: A module name to invoke hook_mail() on. string $key: A key to identify the email sent. string $to: The email address or addresses where the message will be sent to. string $langcode: Language code to use to compose the email. array $params: (optional) Parameters to build the email. string|null $reply: Optional email address to be used to answer. bool $send: If TRUE, call an implementation of \\Drupal\\Core\\Mail\\MailInterface-\u003email() to deliver the message. One thing I noticed was that the options to pass into $params were not on this page, nor could I find documentation for this. I did however come across a very helpful article by Danny Sipos called Using and Extending the Drupal 8 Mail API. This article has everything you need to know on this subject and helped me figure out that I could use $params[‘message’] and $params[‘subject’] for my email. Below is my ‘draft’ code for the day7 module as there are some improvements that could be made including additional code to test if the email was sent and logging.\nday7.info.yml\nname: Day 7 Cron Email type: module description: Sends welcome email to registered users package: Custom core: 8.x day7.module\n\u003c?php use Drupal\\Core\\Entity\\EntityInterface; use Drupal\\Core\\Queue\\QueueFactory; use Drupal\\Core\\Queue\\QueueInterface; /** * Implements hook_entity_insert(). * @param EntityInterface $entity */ function day7_entity_insert(EntityInterface $entity) { if ($entity-\u003egetEntityTypeId() !== 'user') { return; } /** @var QueueFactory $queue_factory */ $queue_factory = \\Drupal::service('queue'); /** @var QueueInterface $queue */ $queue = $queue_factory-\u003eget('user_mailer'); $item = new \\stdClass(); $item-\u003enid = $entity-\u003eid(); $queue-\u003ecreateItem($item); } Plugin/QueueWorker/UserMailer.php\n\u003cphp /** * @file * Contains Drupal\\npq\\Plugin\\QueueWorker\\NodePublishBase.php */ namespace Drupal\\day7\\Plugin\\QueueWorker; use Drupal\\Core\\Entity\\EntityStorageInterface; use Drupal\\Core\\Mail\\MailManagerInterface; use Drupal\\Core\\Plugin\\ContainerFactoryPluginInterface; use Drupal\\Core\\Queue\\QueueWorkerBase; use Drupal\\node\\NodeInterface; use Symfony\\Component\\DependencyInjection\\ContainerInterface; /** * User mailer to send a welcome email to new user. * * @QueueWorker( * id = \"cron_user_mailer\", * title = @Translation(\"Cron User Mailer\"), * cron = {\"time\" = 10} * ) */ abstract class UserMailer extends QueueWorkerBase implements ContainerFactoryPluginInterface { /** * The node storage. * * @var \\Drupal\\Core\\Entity\\EntityStorageInterface */ protected $userStorage; /** * The mail manager. * * @var \\Drupal\\Core\\Mail\\MailManagerInterface */ protected $mailManager; /** * Creates a new UserMailer. * * @param \\Drupal\\Core\\Entity\\EntityStorageInterface $user_storage * The user storage. * @param \\Drupal\\Core\\Mail\\MailManagerInterface $mail_manager * The mail manager. * * * */ public function __construct(EntityStorageInterface $user_storage, MailManagerInterface $mail_manager) { $this-\u003euserStorage = $user_storage; $this-\u003emailManager = $mail_manager; } /** * {@inheritdoc} */ public static function create(ContainerInterface $container, array $configuration, $plugin_id, $plugin_definition) { return new static( $container-\u003eget('entity.manager')-\u003egetStorage('user'), $container-\u003eget('plugin.manager.mail') ); } /** * {@inheritdoc} */ protected function sendEmail($data) { $user = $this-\u003euserStorage-\u003eload($data-\u003enid); $module = 'Day7'; $key = 'cron_email', $to = $user-\u003egetEmail(); $langcode = $user-\u003egetPreferredLangcode(); $params['subject'] = 'Welcome to our site'; $params['message'] = 'Thank you for registering at our site'; $send = true; // TODO: Add Logging in Real Implementations $this-\u003emailManager-\u003email($module, $key, $to, $langcode, $params, NULL, $send); } } ","wordCount":"963","inLanguage":"en","image":"https://www.carnaghan.com/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2016-08-13T00:00:00Z","dateModified":"2016-08-13T00:00:00Z","author":{"@type":"Person","name":"icarnaghan"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.carnaghan.com/cron-queuing-in-drupal-8/"},"publisher":{"@type":"Organization","name":"Ian Carnaghan","logo":{"@type":"ImageObject","url":"https://www.carnaghan.com/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.carnaghan.com/ accesskey=h title="Ian Carnaghan (Alt + H)"><img src=https://www.carnaghan.com/apple-touch-icon.png alt aria-label=logo height=35>Ian Carnaghan</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.carnaghan.com/about-me/ title="About Me"><span>About Me</span></a></li><li><a href=https://www.carnaghan.com/categories/coding/ title=Coding><span>Coding</span></a></li><li><a href=https://www.carnaghan.com/bitesize-javascript/ title="Bitesize JavaScript"><span>Bitesize JavaScript</span></a></li><li><a href=https://www.carnaghan.com/categories/data-analytics/ title="Data Analytics"><span>Data Analytics</span></a></li><li><a href=https://www.carnaghan.com/categories/cybersecurity/ title=Cybersecurity><span>Cybersecurity</span></a></li><li><a href=https://www.carnaghan.com/categories/ux-design/ title="UX and Design"><span>UX and Design</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.carnaghan.com/>Home</a>&nbsp;»&nbsp;<a href=https://www.carnaghan.com/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Cron Queuing in Drupal 8</h1><div class=post-meta><span title='2016-08-13 00:00:00 +0000 UTC'>August 13, 2016</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;963 words&nbsp;·&nbsp;icarnaghan&nbsp;|&nbsp;<a href=https://github.com/icarnaghan/carnaghan.com/content/posts/cron-queuing-in-drupal-8/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>Day 7 focuses mainly on the Drupal Queue API. The main resource for this card is an article called Drupal 8 Queue API – Powerful Manual and Cron Queueing, which I had referenced in an earlier post. Before completing any of the materials, I had no previous experience with the Queue API, nor hook_entity_insert, which was used to create a demo queue system in the referenced article. After going through the article I gained a better understanding of how the queue system works. At a high level the following steps outline the process of constructing the module that is documented in this article along with relevant links to the API.</p><h2 id=creating-the-queue>Creating the Queue<a hidden class=anchor aria-hidden=true href=#creating-the-queue>#</a></h2><ol><li>Create the .module file and use hook_entity_insert to grab any newly inserted entities of type node, check publish status, and if unpublished create a queue via the QueueFactory (step).</li><li>Get the queue factory service via \Drupal::service(&lsquo;queue&rsquo;) which references the QueueFactory class and then use the get method to create a new queue of type QueueInterface.</li><li>Instantiate a new class stdclass() called $item and pass in the nid from the inserted entity.</li><li>Use the QueueInterface createItem method to pass in $item.</li></ol><h2 id=building-the-queueworker-plugin>Building the QueueWorker Plugin<a hidden class=anchor aria-hidden=true href=#building-the-queueworker-plugin>#</a></h2><p>We will be getting more into plugins in Day 8, however for the purpose of using the Queue API in this example, a plugin was created to manage publishing of and processing items in the queue.</p><ol><li>Create the plugin at src/Plugin/QueueWorker which extends QueueWorkerBase and implements the ContainerFactoryPluginInterface.</li><li>Inject EntityStorageInterface into the plugin (required for publishing nodes).</li><li>Write the methods for processing queue items and publishing nodes.</li></ol><p>The Drupal 8 Queue API article setup the plugin as an abstract class and extended it to provide both cron as well as manual calls to the plugin. An additional form was buit to provide user feedback on queue items left and for a way for the user to manually process the queue. The article also provides a git repo of all sourcecode to download and test locally.</p><h2 id=registered-users-welcome-email-queue>Registered Users Welcome Email Queue<a hidden class=anchor aria-hidden=true href=#registered-users-welcome-email-queue>#</a></h2><p>The task for Day 7 was to build a custom module that would similarly use a queue within Drupal 8, only this time instead of queueing inserted nodes, the module would build a queue of new users and then email a welcome message on the next cron run. In order to write this module, I followed similar steps to the article above. First of all I found myself reviewing Drupal 8 Hooks in order to find a registered user hook that I could use for my queue. I quickly realized that no such hook existed and I could in fact use the same hook_entity_insert on users instead of nodes.</p><p>The next thing I needed to figure out was which service I could use for processing emails. I took a look in core.services.yml and came across MailManager which provides a Mail plugin manager. More detailed documentation for the MailManager function is available and this helped figure out how to use it correctly in my code including what parameters needed to be passed in:</p><ul><li><strong>string $module</strong>: A module name to invoke hook_mail() on.</li><li><strong>string $key</strong>: A key to identify the email sent.</li><li><strong>string $to</strong>: The email address or addresses where the message will be sent to.</li><li><strong>string $langcode</strong>: Language code to use to compose the email.</li><li><strong>array $params</strong>: (optional) Parameters to build the email.</li><li><strong>string|null $reply</strong>: Optional email address to be used to answer.</li><li><strong>bool $send</strong>: If TRUE, call an implementation of \Drupal\Core\Mail\MailInterface->mail() to deliver the message.</li></ul><p>One thing I noticed was that the options to pass into $params were not on this page, nor could I find documentation for this. I did however come across a very helpful article by Danny Sipos called Using and Extending the Drupal 8 Mail API. This article has everything you need to know on this subject and helped me figure out that I could use $params[&lsquo;message&rsquo;] and $params[&lsquo;subject&rsquo;] for my email. Below is my &lsquo;draft&rsquo; code for the day7 module as there are some improvements that could be made including additional code to test if the email was sent and logging.</p><p>day7.info.yml</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>name</span><span class=o>:</span> <span class=nx>Day</span> <span class=mi>7</span> <span class=nx>Cron</span> <span class=nx>Email</span>
</span></span><span class=line><span class=cl><span class=nx>type</span><span class=o>:</span> <span class=nx>module</span>
</span></span><span class=line><span class=cl><span class=nx>description</span><span class=o>:</span> <span class=nx>Sends</span> <span class=nx>welcome</span> <span class=nx>email</span> <span class=nx>to</span> <span class=nx>registered</span> <span class=nx>users</span>
</span></span><span class=line><span class=cl><span class=nx>package</span><span class=o>:</span> <span class=nx>Custom</span>
</span></span><span class=line><span class=cl><span class=nx>core</span><span class=o>:</span> <span class=mf>8.</span><span class=nx>x</span>
</span></span></code></pre></div><p>day7.module</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nx>Drupal\Core\Entity\EntityInterface</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nx>Drupal\Core\Queue\QueueFactory</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nx>Drupal\Core\Queue\QueueInterface</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=sd>/**
</span></span></span><span class=line><span class=cl><span class=sd>* Implements hook_entity_insert().
</span></span></span><span class=line><span class=cl><span class=sd>* @param EntityInterface $entity
</span></span></span><span class=line><span class=cl><span class=sd>*/</span>
</span></span><span class=line><span class=cl><span class=k>function</span> <span class=nf>day7_entity_insert</span><span class=p>(</span><span class=nx>EntityInterface</span> <span class=nv>$entity</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nv>$entity</span><span class=o>-&gt;</span><span class=na>getEntityTypeId</span><span class=p>()</span> <span class=o>!==</span> <span class=s1>&#39;user&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=sd>/** @var QueueFactory $queue_factory */</span>
</span></span><span class=line><span class=cl><span class=nv>$queue_factory</span> <span class=o>=</span> <span class=nx>\Drupal</span><span class=o>::</span><span class=na>service</span><span class=p>(</span><span class=s1>&#39;queue&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=sd>/** @var QueueInterface $queue */</span>
</span></span><span class=line><span class=cl><span class=nv>$queue</span> <span class=o>=</span> <span class=nv>$queue_factory</span><span class=o>-&gt;</span><span class=na>get</span><span class=p>(</span><span class=s1>&#39;user_mailer&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$item</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>\stdClass</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$item</span><span class=o>-&gt;</span><span class=na>nid</span> <span class=o>=</span> <span class=nv>$entity</span><span class=o>-&gt;</span><span class=na>id</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$queue</span><span class=o>-&gt;</span><span class=na>createItem</span><span class=p>(</span><span class=nv>$item</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Plugin/QueueWorker/UserMailer.php</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=sd>/**
</span></span></span><span class=line><span class=cl><span class=sd>* @file
</span></span></span><span class=line><span class=cl><span class=sd>* Contains Drupal\npq\Plugin\QueueWorker\NodePublishBase.php
</span></span></span><span class=line><span class=cl><span class=sd>*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nx>Drupal\day7\Plugin\QueueWorker</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nx>Drupal\Core\Entity\EntityStorageInterface</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nx>Drupal\Core\Mail\MailManagerInterface</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nx>Drupal\Core\Plugin\ContainerFactoryPluginInterface</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nx>Drupal\Core\Queue\QueueWorkerBase</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nx>Drupal\node\NodeInterface</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nx>Symfony\Component\DependencyInjection\ContainerInterface</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=sd>/**
</span></span></span><span class=line><span class=cl><span class=sd>* User mailer to send a welcome email to new user.
</span></span></span><span class=line><span class=cl><span class=sd>*
</span></span></span><span class=line><span class=cl><span class=sd>* @QueueWorker(
</span></span></span><span class=line><span class=cl><span class=sd>*   id = &#34;cron_user_mailer&#34;,
</span></span></span><span class=line><span class=cl><span class=sd>*   title = @Translation(&#34;Cron User Mailer&#34;),
</span></span></span><span class=line><span class=cl><span class=sd>*   cron = {&#34;time&#34; = 10}
</span></span></span><span class=line><span class=cl><span class=sd>* )
</span></span></span><span class=line><span class=cl><span class=sd>*/</span>
</span></span><span class=line><span class=cl><span class=k>abstract</span> <span class=k>class</span> <span class=nc>UserMailer</span> <span class=k>extends</span> <span class=nx>QueueWorkerBase</span> <span class=k>implements</span> <span class=nx>ContainerFactoryPluginInterface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=sd>/**
</span></span></span><span class=line><span class=cl><span class=sd>* The node storage.
</span></span></span><span class=line><span class=cl><span class=sd>*
</span></span></span><span class=line><span class=cl><span class=sd>* @var \Drupal\Core\Entity\EntityStorageInterface
</span></span></span><span class=line><span class=cl><span class=sd>*/</span>
</span></span><span class=line><span class=cl><span class=k>protected</span> <span class=nv>$userStorage</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=sd>/**
</span></span></span><span class=line><span class=cl><span class=sd>* The mail manager.
</span></span></span><span class=line><span class=cl><span class=sd>*
</span></span></span><span class=line><span class=cl><span class=sd>* @var \Drupal\Core\Mail\MailManagerInterface
</span></span></span><span class=line><span class=cl><span class=sd>*/</span>
</span></span><span class=line><span class=cl><span class=k>protected</span> <span class=nv>$mailManager</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=sd>/**
</span></span></span><span class=line><span class=cl><span class=sd>* Creates a new UserMailer.
</span></span></span><span class=line><span class=cl><span class=sd>*
</span></span></span><span class=line><span class=cl><span class=sd>* @param \Drupal\Core\Entity\EntityStorageInterface $user_storage
</span></span></span><span class=line><span class=cl><span class=sd>*   The user storage.
</span></span></span><span class=line><span class=cl><span class=sd>* @param \Drupal\Core\Mail\MailManagerInterface $mail_manager
</span></span></span><span class=line><span class=cl><span class=sd>*   The mail manager.
</span></span></span><span class=line><span class=cl><span class=sd>*
</span></span></span><span class=line><span class=cl><span class=sd>*
</span></span></span><span class=line><span class=cl><span class=sd>*
</span></span></span><span class=line><span class=cl><span class=sd>*/</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>(</span><span class=nx>EntityStorageInterface</span> <span class=nv>$user_storage</span><span class=p>,</span> <span class=nx>MailManagerInterface</span> <span class=nv>$mail_manager</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>userStorage</span> <span class=o>=</span> <span class=nv>$user_storage</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>mailManager</span> <span class=o>=</span> <span class=nv>$mail_manager</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=sd>/**
</span></span></span><span class=line><span class=cl><span class=sd>* {@inheritdoc}
</span></span></span><span class=line><span class=cl><span class=sd>*/</span>
</span></span><span class=line><span class=cl><span class=k>public</span> <span class=k>static</span> <span class=k>function</span> <span class=nf>create</span><span class=p>(</span><span class=nx>ContainerInterface</span> <span class=nv>$container</span><span class=p>,</span> <span class=k>array</span> <span class=nv>$configuration</span><span class=p>,</span> <span class=nv>$plugin_id</span><span class=p>,</span> <span class=nv>$plugin_definition</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=k>new</span> <span class=k>static</span><span class=p>(</span>
</span></span><span class=line><span class=cl><span class=nv>$container</span><span class=o>-&gt;</span><span class=na>get</span><span class=p>(</span><span class=s1>&#39;entity.manager&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>getStorage</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=nv>$container</span><span class=o>-&gt;</span><span class=na>get</span><span class=p>(</span><span class=s1>&#39;plugin.manager.mail&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=sd>/**
</span></span></span><span class=line><span class=cl><span class=sd>* {@inheritdoc}
</span></span></span><span class=line><span class=cl><span class=sd>*/</span>
</span></span><span class=line><span class=cl><span class=k>protected</span> <span class=k>function</span> <span class=nf>sendEmail</span><span class=p>(</span><span class=nv>$data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nv>$user</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>userStorage</span><span class=o>-&gt;</span><span class=na>load</span><span class=p>(</span><span class=nv>$data</span><span class=o>-&gt;</span><span class=na>nid</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$module</span> <span class=o>=</span> <span class=s1>&#39;Day7&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$key</span> <span class=o>=</span> <span class=s1>&#39;cron_email&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nv>$to</span> <span class=o>=</span> <span class=nv>$user</span><span class=o>-&gt;</span><span class=na>getEmail</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$langcode</span> <span class=o>=</span> <span class=nv>$user</span><span class=o>-&gt;</span><span class=na>getPreferredLangcode</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nv>$params</span><span class=p>[</span><span class=s1>&#39;subject&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;Welcome to our site&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$params</span><span class=p>[</span><span class=s1>&#39;message&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;Thank you for registering at our site&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nv>$send</span> <span class=o>=</span> <span class=k>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// TODO: Add Logging in Real Implementations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>mailManager</span><span class=o>-&gt;</span><span class=na>mail</span><span class=p>(</span><span class=nv>$module</span><span class=p>,</span> <span class=nv>$key</span><span class=p>,</span> <span class=nv>$to</span><span class=p>,</span> <span class=nv>$langcode</span><span class=p>,</span> <span class=nv>$params</span><span class=p>,</span> <span class=k>NULL</span><span class=p>,</span> <span class=nv>$send</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.carnaghan.com/tags/drupal/>Drupal</a></li></ul><nav class=paginav><a class=prev href=https://www.carnaghan.com/drupal-8-plugin-system/><span class=title>« Prev</span><br><span>Drupal 8 Plugin System</span>
</a><a class=next href=https://www.carnaghan.com/is-shared-hosting-bad-for-seo-and-is-it-safe-for-your-site/><span class=title>Next »</span><br><span>Is Shared hosting bad for SEO and is it safe for your site?</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Cron Queuing in Drupal 8 on x" href="https://x.com/intent/tweet/?text=Cron%20Queuing%20in%20Drupal%208&amp;url=https%3a%2f%2fwww.carnaghan.com%2fcron-queuing-in-drupal-8%2f&amp;hashtags=drupal"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Cron Queuing in Drupal 8 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fwww.carnaghan.com%2fcron-queuing-in-drupal-8%2f&amp;title=Cron%20Queuing%20in%20Drupal%208&amp;summary=Cron%20Queuing%20in%20Drupal%208&amp;source=https%3a%2f%2fwww.carnaghan.com%2fcron-queuing-in-drupal-8%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Cron Queuing in Drupal 8 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.carnaghan.com%2fcron-queuing-in-drupal-8%2f&title=Cron%20Queuing%20in%20Drupal%208"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Cron Queuing in Drupal 8 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.carnaghan.com%2fcron-queuing-in-drupal-8%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Cron Queuing in Drupal 8 on whatsapp" href="https://api.whatsapp.com/send?text=Cron%20Queuing%20in%20Drupal%208%20-%20https%3a%2f%2fwww.carnaghan.com%2fcron-queuing-in-drupal-8%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Cron Queuing in Drupal 8 on telegram" href="https://telegram.me/share/url?text=Cron%20Queuing%20in%20Drupal%208&amp;url=https%3a%2f%2fwww.carnaghan.com%2fcron-queuing-in-drupal-8%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Cron Queuing in Drupal 8 on ycombinator" href="https://news.ycombinator.com/submitlink?t=Cron%20Queuing%20in%20Drupal%208&u=https%3a%2f%2fwww.carnaghan.com%2fcron-queuing-in-drupal-8%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//carnaghan.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2025 <a href=https://www.carnaghan.com/>Ian Carnaghan</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>